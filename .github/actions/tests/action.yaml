name: 'Tests'
description: 'test the source code'
runs:
  using: 'composite'
  steps:
    - name: Set up QEMU
      if: ${{ !contains(github.event.head_commit.message, '#skip-tests') }}
      uses: docker/setup-qemu-action@v2

    - name: Set up Docker Buildx
      if: ${{ !contains(github.event.head_commit.message, '#skip-tests') }}
      id: buildx
      uses: docker/setup-buildx-action@v2

    - name: Cache Docker layers
      if: ${{ !contains(github.event.head_commit.message, '#skip-tests') }}
      uses: actions/cache@v2
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ hashFiles('Dockerfile.test') }}
        restore-keys: |
          ${{ runner.os }}-buildx-${{ hashFiles('Dockerfile.test') }}

    - name: 'test - Build'
      if: ${{ !contains(github.event.head_commit.message, '#skip-tests') }}
      run: |
        docker buildx build \
          --load \
          --platform "linux/amd64" \
          --cache-from "type=gha" \
          --cache-to "type=gha,mode=max" \
          -t "demo-test:latest" \
          -f "Dockerfile.test" \
          .

    - name: Run Tests
      if: ${{ !contains(github.event.head_commit.message, '#skip-tests') }}
      uses: adrielcodeco/docker-compose-run-action@main
      with:
        compose-file: './docker-compose.yml'
        service: demo-test
